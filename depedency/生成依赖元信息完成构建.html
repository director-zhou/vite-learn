<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vite 源码学习</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/vite-learn/assets/css/0.styles.13e0bdfe.css" as="style"><link rel="preload" href="/vite-learn/assets/js/app.2c7ee9f3.js" as="script"><link rel="preload" href="/vite-learn/assets/js/2.8f7adacc.js" as="script"><link rel="preload" href="/vite-learn/assets/js/21.7c05d01d.js" as="script"><link rel="prefetch" href="/vite-learn/assets/js/10.92d4399d.js"><link rel="prefetch" href="/vite-learn/assets/js/11.e5276b76.js"><link rel="prefetch" href="/vite-learn/assets/js/12.591f2923.js"><link rel="prefetch" href="/vite-learn/assets/js/13.725b875f.js"><link rel="prefetch" href="/vite-learn/assets/js/14.ad80e4a6.js"><link rel="prefetch" href="/vite-learn/assets/js/15.fee7330a.js"><link rel="prefetch" href="/vite-learn/assets/js/16.5084fc75.js"><link rel="prefetch" href="/vite-learn/assets/js/17.d54d0bf0.js"><link rel="prefetch" href="/vite-learn/assets/js/18.2d29ec62.js"><link rel="prefetch" href="/vite-learn/assets/js/19.31bbcb69.js"><link rel="prefetch" href="/vite-learn/assets/js/20.857f00c0.js"><link rel="prefetch" href="/vite-learn/assets/js/22.bc53c9c5.js"><link rel="prefetch" href="/vite-learn/assets/js/23.11dc65cd.js"><link rel="prefetch" href="/vite-learn/assets/js/24.19f32ccd.js"><link rel="prefetch" href="/vite-learn/assets/js/25.e036f7c2.js"><link rel="prefetch" href="/vite-learn/assets/js/26.4cfa5155.js"><link rel="prefetch" href="/vite-learn/assets/js/3.ff647eb2.js"><link rel="prefetch" href="/vite-learn/assets/js/4.aa1e20fb.js"><link rel="prefetch" href="/vite-learn/assets/js/5.3510c9da.js"><link rel="prefetch" href="/vite-learn/assets/js/6.346ac952.js"><link rel="prefetch" href="/vite-learn/assets/js/7.c087e119.js"><link rel="prefetch" href="/vite-learn/assets/js/8.89123153.js"><link rel="prefetch" href="/vite-learn/assets/js/9.ade172d4.js">
    <link rel="stylesheet" href="/vite-learn/assets/css/0.styles.13e0bdfe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vite-learn/" class="home-link router-link-active"><!----> <span class="site-name">Vite 源码学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="//github.com/director-zhou/vite-learn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="//github.com/director-zhou/vite-learn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>依赖预构建</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vite-learn/depedency/为什么需要预构建一.html" class="sidebar-link">为什么需要预构建(一)</a></li><li><a href="/vite-learn/depedency/为什么需要预构建二.html" class="sidebar-link">为什么需要预构建(二)</a></li><li><a href="/vite-learn/depedency/预构建触发时机.html" class="sidebar-link">预构建触发时机</a></li><li><a href="/vite-learn/depedency/预构建执行逻辑.html" class="sidebar-link">预构建执行逻辑</a></li><li><a href="/vite-learn/depedency/预构建核心方法optimizeDeps.html" class="sidebar-link">预构建核心方法optimizeDeps</a></li><li><a href="/vite-learn/depedency/构建准备.html" class="sidebar-link">构建准备</a></li><li><a href="/vite-learn/depedency/自动依赖搜寻.html" class="sidebar-link">自动依赖搜寻</a></li><li><a href="/vite-learn/depedency/确定扫描入口文件.html" class="sidebar-link">确定扫描入口文件</a></li><li><a href="/vite-learn/depedency/如何执行扫描.html" class="sidebar-link">如何执行扫描</a></li><li><a href="/vite-learn/depedency/esbuild插件基础介绍.html" class="sidebar-link">esbuild插件基础介绍</a></li><li><a href="/vite-learn/depedency/收集依赖插件esbuildScanPlugin.html" class="sidebar-link">收集依赖插件esbuildScanPlugin</a></li><li><a href="/vite-learn/depedency/HTML入口扫描.html" class="sidebar-link">HTML入口扫描</a></li><li><a href="/vite-learn/depedency/扫描导入链路.html" class="sidebar-link">扫描导入链路</a></li><li><a href="/vite-learn/depedency/收集依赖.html" class="sidebar-link">收集依赖</a></li><li><a href="/vite-learn/depedency/利用并完善依赖.html" class="sidebar-link">利用并完善依赖</a></li><li><a href="/vite-learn/depedency/构建前准备工作.html" class="sidebar-link">构建前准备工作</a></li><li><a href="/vite-learn/depedency/构建文件处理esbuildDepPluginOne.html" class="sidebar-link">构建文件处理esbuildDepPlugin(一)</a></li><li><a href="/vite-learn/depedency/构建文件处理esbuildDepPluginTwo.html" class="sidebar-link">构建文件处理esbuildDepPlugin(二)</a></li><li><a href="/vite-learn/depedency/生成依赖元信息完成构建.html" class="active sidebar-link">生成依赖元信息完成构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#构建结果" class="sidebar-link">构建结果</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#生成依赖元信息" class="sidebar-link">生成依赖元信息</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#needsinterop-理解" class="sidebar-link">needsInterop 理解</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#vite对于混用导入导出的解决方案" class="sidebar-link">vite对于混用导入导出的解决方案</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#metafile-构建文件描述" class="sidebar-link">metafile 构建文件描述</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#needsinterop结果实现方式" class="sidebar-link">needsInterop结果实现方式</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/生成依赖元信息完成构建.html#写入构建元信息文件" class="sidebar-link">写入构建元信息文件</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>通过<code>esbuild</code>构建完成之后,在默认缓存文件中会生成收集依赖构建后的文件。同时还需要对每个构建文件的结果进行添加元信息描述, 为了后续加载模块时可以寻找到对应的构建结果文件。</p> <h2 id="构建结果"><a href="#构建结果" class="header-anchor">#</a> 构建结果</h2> <p>比如我们收集到以下需要构建的依赖:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  lodash<span class="token operator">:</span> <span class="token string">'/Users/admin/zzx/test/node_modules/lodash/lodash.js'</span><span class="token punctuation">,</span>
  dayjs<span class="token operator">:</span> <span class="token string">'/Users/admin/zzx/test/node_modules/dayjs/dayjs.min.js'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时将会在目录中生成这样的文件目录结构:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">-</span>node_modules
<span class="token operator">--</span><span class="token punctuation">.</span>vite
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>dayjs<span class="token punctuation">.</span>js
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>dayjs<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>lodash<span class="token punctuation">.</span>js
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>lodash<span class="token punctuation">.</span>js<span class="token punctuation">.</span>map
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>chunk<span class="token operator">-</span><span class="token constant">VK5M77CT</span><span class="token punctuation">.</span>js
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>chunk<span class="token operator">-</span><span class="token constant">VK5M77CT</span><span class="token punctuation">.</span>js<span class="token punctuation">.</span>map
</code></pre></div><p>每个收集的依赖都会生成对应的 <code>id.js</code> 文件，和 <code>id.js.map</code> 文件, 同时大于两条依赖, 将会生成共公模块的 <code>chunk</code> 文件。</p> <h2 id="生成依赖元信息"><a href="#生成依赖元信息" class="header-anchor">#</a> 生成依赖元信息</h2> <p>不但要对收集好的依赖文件进行 <strong>esbuild</strong> 构建，同时还需要给每个收集到的依赖模块的构建结果, 生成对应加载时寻找文件映射路径和一些是否需要强制操作的信息映射。
<strong>Vite</strong> 将这些映射信息存放在<code>元信息</code>的 <code>data</code> 的 <code>optimized</code> 对象内。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">in</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> entry <span class="token operator">=</span> deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
  data<span class="token punctuation">.</span>optimized<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    file<span class="token operator">:</span> <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>cacheDir<span class="token punctuation">,</span> <span class="token function">flattenId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    src<span class="token operator">:</span> entry<span class="token punctuation">,</span>
    needsInterop<span class="token operator">:</span> <span class="token function">needsInterop</span><span class="token punctuation">(</span>
      id<span class="token punctuation">,</span>
      idToExports<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span>
      meta<span class="token punctuation">.</span>outputs<span class="token punctuation">,</span>
      cacheDirOutputPath
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要对每个依赖都要进行生成元信息，通过<code>for in</code> 循环对每个依赖进行生成元信息,将会生成以下内容:</p> <ol><li><code>file</code> 用来保存依赖文件构建后存在的绝对路径，以便加载时，直接定位到文件路径。</li> <li><code>src</code>  依赖的真正需要构建的入口文件。</li> <li><code>needsInterop</code> 是否需要进行强制操作。</li></ol> <h2 id="needsinterop-理解"><a href="#needsinterop-理解" class="header-anchor">#</a> needsInterop 理解</h2> <p><code>needsInterop</code>是一个 <code>Boolean</code> 值,如果构建的入口文件采用 <code>esm</code> 的方式，则为 <code>false</code>, 如果是 <code>umd</code> 或者 <code>cjs</code> 则为<code>true</code>, <code>cjs</code> 的导入模块方式会引起 <code>esbuild</code> 构建结果有差异, 这种差异是因为 <code>esm</code> 与 <code>cjs</code> 语法进行混用导致的结果。</p> <h3 id="导入导出混用"><a href="#导入导出混用" class="header-anchor">#</a> 导入导出混用:</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//entry.js</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">,</span>
  b
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./entry'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> entry
</code></pre></div><p>通过 <strong>esbuild</strong> 构建 <code>main.js</code> 入口文件,导入构建后文件将会打印以下结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> result <span class="token keyword">from</span> <span class="token string">'esbuild构建mian.js的文件'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

<span class="token comment">// 打印结果</span>
<span class="token punctuation">{</span>
  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
  __esModule<span class="token operator">:</span> <span class="token boolean">true</span>
  get <span class="token function-variable function">default</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> entry2_default
  __proto__<span class="token operator">:</span> Object
<span class="token punctuation">}</span>
</code></pre></div><p>可想而知在这并不是最终要的络果。得到真正的结果还需要进行 <code>result.default</code> 才能拿到真正的结果。</p> <h3 id="混用导入导出有时也并不会变异"><a href="#混用导入导出有时也并不会变异" class="header-anchor">#</a> 混用导入导出有时也并不会变异</h3> <p>前面是 <code>entry.js</code> 通过 <code>esm</code> 方式进行导出，在 <code>main</code> 中通过 <code>cjs</code> 的方式进行混用导入导出。</p> <p>如果 <code>entry.js</code> 通过 <code>cjs</code> 进行导出，在 <code>main.js</code> 中通过 <code>esm</code> 的方式进行混用导入导出。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// entry.js</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token punctuation">,</span>b
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> entry2 <span class="token keyword">from</span> <span class="token string">'./entry2'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> entry2
</code></pre></div><p>通过 <code>esbuild</code> 构建 <code>main.js</code> 入口文件,引入构建后文件将会打印以下结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> result <span class="token keyword">from</span> <span class="token string">'esbuild构建mian.js的文件'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

<span class="token comment">// 打印结果</span>
<span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> b<span class="token operator">:</span><span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从此结果可以得出如果是构建的文件如果是 <code>cjs</code> 的方式，就可能会存在导入导出混用最后的返回结果存在变异。</p> <h2 id="vite对于混用导入导出的解决方案"><a href="#vite对于混用导入导出的解决方案" class="header-anchor">#</a> <code>vite</code>对于混用导入导出的解决方案</h2> <p>文件以引入以下模块为例:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// main.js</span>
<span class="token keyword">import</span> dayjs <span class="token keyword">from</span> <span class="token string">'dayjs'</span>
<span class="token keyword">import</span> lodash <span class="token keyword">from</span> <span class="token string">'lodash-es'</span>
</code></pre></div><p>打开 <code>network</code> 找到 <code>main.js</code> 文件可以发现,原本的引入方式,在服务端已经被 <code>importAnalysis</code> 插件中的 <code>transfom</code> 进行了转换。以下为转换结果:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> __vite__cjsImport0_dayjs <span class="token keyword">from</span> <span class="token string">&quot;/node_modules/.vite/dayjs.js?v=94ade23a&quot;</span><span class="token punctuation">;</span> <span class="token keyword">const</span> dayjs <span class="token operator">=</span> __vite__cjsImport0_dayjs<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> __vite__cjsImport0_dayjs<span class="token punctuation">.</span>default <span class="token operator">:</span> __vite__cjsImport0_dayjs
<span class="token keyword">import</span> lodashES <span class="token keyword">from</span> <span class="token string">'/node_modules/.vite/lodash-es.js?v=94ade23a'</span>
</code></pre></div><p>对于 <code>cjs</code> 导出模块 <code>dayjs</code> 做了一层值的判断，如果导出对象上有 <code>__esModule</code>,最终结果是返回导入模块对象上的 <code>deafult</code> 属性。否则直接返回,这样就可以对于 <code>cjs</code> 模块的预构建后结果差异和非差异的情况都可以进行正确的返回。</p> <h2 id="metafile-构建文件描述"><a href="#metafile-构建文件描述" class="header-anchor">#</a> <code>metafile</code> 构建文件描述</h2> <blockquote><p>构建结果的每个文件元信息。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> meta <span class="token operator">=</span> result<span class="token punctuation">.</span>metafile<span class="token operator">!</span>
</code></pre></div><p>示例:</p> <p>当导入以下模块时,将被收集到依赖中进行构建产出对应的描述。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> dayjs <span class="token keyword">from</span> <span class="token string">'dayjs'</span>
<span class="token keyword">import</span> lodashES <span class="token keyword">from</span> <span class="token string">'lodash-es'</span>
</code></pre></div><h3 id="metafile中有两大核心描述"><a href="#metafile中有两大核心描述" class="header-anchor">#</a> metafile中有两大核心描述:</h3> <ol><li><code>inputs</code>:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'node_modules/dayjs/dayjs.min.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span> bytes<span class="token operator">:</span> <span class="token number">6479</span><span class="token punctuation">,</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'dep:dayjs'</span><span class="token operator">:</span> <span class="token punctuation">{</span> bytes<span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/lodash-es/_freeGlobal.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span> bytes<span class="token operator">:</span> <span class="token number">171</span><span class="token punctuation">,</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/lodash-es/_root.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span> bytes<span class="token operator">:</span> <span class="token number">298</span><span class="token punctuation">,</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token string">'dep:lodash-es'</span><span class="token operator">:</span> <span class="token punctuation">{</span> bytes<span class="token operator">:</span> <span class="token number">119</span><span class="token punctuation">,</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span> <span class="token punctuation">}</span>
</code></pre></div><p><code>inputs</code>内包涵了构建时所有引用到模块和构建完成后的模块里的描述</p> <ol start="2"><li><code>outputs</code>:</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'node_modules/.vite/dayjs.js.map'</span><span class="token operator">:</span> <span class="token punctuation">{</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bytes<span class="token operator">:</span> <span class="token number">15179</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/.vite/dayjs.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
  entryPoint<span class="token operator">:</span> <span class="token string">'dep:dayjs'</span><span class="token punctuation">,</span>
  inputs<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
  bytes<span class="token operator">:</span> <span class="token number">10704</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/.vite/lodash-es.js.map'</span><span class="token operator">:</span> <span class="token punctuation">{</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bytes<span class="token operator">:</span> <span class="token number">790090</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/.vite/lodash-es.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span>
  entryPoint<span class="token operator">:</span> <span class="token string">'dep:lodash-es'</span><span class="token punctuation">,</span>
  inputs<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span><span class="token punctuation">,</span>
  bytes<span class="token operator">:</span> <span class="token number">283210</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/.vite/chunk-VK5M77CT.js.map'</span><span class="token operator">:</span> <span class="token punctuation">{</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bytes<span class="token operator">:</span> <span class="token number">93</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token string">'node_modules/.vite/chunk-VK5M77CT.js'</span><span class="token operator">:</span> <span class="token punctuation">{</span> imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> exports<span class="token operator">:</span> <span class="token punctuation">[</span>Array<span class="token punctuation">]</span><span class="token punctuation">,</span> inputs<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bytes<span class="token operator">:</span> <span class="token number">221</span> <span class="token punctuation">}</span>
</code></pre></div><p><code>outputs</code>内包含了构建结果描述。</p> <h2 id="needsinterop结果实现方式"><a href="#needsinterop结果实现方式" class="header-anchor">#</a> <code>needsInterop</code>结果实现方式</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">needsInterop</span><span class="token punctuation">(</span>
  <span class="token parameter">id<span class="token operator">:</span> string<span class="token punctuation">,</span>
  exportsData<span class="token operator">:</span> ExportsData<span class="token punctuation">,</span>
  outputs<span class="token operator">:</span> Record<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cacheDirOutputPath<span class="token operator">:</span> string</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="参数理解"><a href="#参数理解" class="header-anchor">#</a> 参数理解</h3> <ol><li><code>id</code> 收集依赖的导入模块名称。</li> <li><code>exportsData</code> 收集依赖模块的入口文件内容通过 <code>es-module-lexer</code> 词法解析后的描述。</li> <li><code>outputs</code> 构建结果文件信息描述。</li> <li><code>cacheDirOutputPath</code> 构建结果的缓存目录。</li></ol> <h3 id="处理伪装模块"><a href="#处理伪装模块" class="header-anchor">#</a> 处理伪装模块</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">KNOWN_INTEROP_IDS</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'moment'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">KNOWN_INTEROP_IDS</span><span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对 <code>moment</code> 模块单做特殊处理, 因为 <code>moment</code> 使用的是 <code>ESM</code> 导出导入, 但仍使用 <code>require</code> 关键字, 这会导致 <code>esbuild</code> 将它们包装为 <code>CJS</code>，即使其入口看起来是 <code>ESM</code>。所以还是需要当作 <code>CJS</code> 的方式进行处理。
<a href="https://github.com/vitejs/vite/issues/1724#issuecomment-767619642" target="_blank" rel="noopener noreferrer">issus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="处理非esm模块"><a href="#处理非esm模块" class="header-anchor">#</a> 处理非esm模块</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>imports<span class="token punctuation">,</span> exports<span class="token punctuation">]</span> <span class="token operator">=</span> exportsData
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exports<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>imports<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过词法分析没有 <code>import</code> 内容描述或者 <code>exports</code> 的内容描述, 一定是 <code>cjs</code> 词法或者 <code>umd</code> 的词法，一律当作 <code>cjs</code> 进行处理。</p> <h3 id="寻找模块对应的生成描述"><a href="#寻找模块对应的生成描述" class="header-anchor">#</a> 寻找模块对应的生成描述</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> flatId <span class="token operator">=</span> <span class="token function">flattenId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.js'</span>
<span class="token keyword">let</span> generatedExports<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> output <span class="token keyword">in</span> outputs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token function">normalizePath</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">===</span>
    <span class="token function">normalizePath</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>cacheDirOutputPath<span class="token punctuation">,</span> flatId<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    generatedExports <span class="token operator">=</span> outputs<span class="token punctuation">[</span>output<span class="token punctuation">]</span><span class="token punctuation">.</span>exports
    <span class="token keyword">break</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过循环找到对应依赖的构建描述 <code>exports</code> 属性。同时赋值在 <code>generatedExports</code> 变量上, 进行继续判断。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">isSingleDefaultExport</span><span class="token punctuation">(</span><span class="token parameter">exports<span class="token operator">:</span> string<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> exports<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> exports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'default'</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token operator">!</span>generatedExports <span class="token operator">||</span>
  <span class="token punctuation">(</span><span class="token function">isSingleDefaultExport</span><span class="token punctuation">(</span>generatedExports<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSingleDefaultExport</span><span class="token punctuation">(</span>exports<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>如果模块的构建导出描述中没有任何导出内容， 说明没有用 <code>esm</code> 语法进行导出，则认定为 <code>cjs</code> 语法。</li> <li>因为 <code>es-module-lexer</code> 的词法解析方式，与 esbuild 构建生成描述的词法解析方式有差异, 差异在于 <code>export *</code> 这个语法。 <code>es-module-lexer</code> 在解析 <code>export *</code> 这样的语法，exports词法分析的结果不会有任何内容, 存在差异也被认为 <code>cjs</code> 的法语。</li> <li>否则其它情况都认为 <code>esm</code> 的正确导入依赖方式。并没有可能存在混用。</li></ol> <h2 id="写入构建元信息文件"><a href="#写入构建元信息文件" class="header-anchor">#</a> 写入构建元信息文件</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">writeFile</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> data
</code></pre></div><p>最后向 <code>cacheDir</code> 中写入 <code>_metadata.json</code> 文件,同时返回结果给到 <code>server._optimizeDepsMetadata</code>。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vite-learn/depedency/构建文件处理esbuildDepPluginTwo.html" class="prev">
        构建文件处理esbuildDepPlugin(二)
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vite-learn/assets/js/app.2c7ee9f3.js" defer></script><script src="/vite-learn/assets/js/2.8f7adacc.js" defer></script><script src="/vite-learn/assets/js/21.7c05d01d.js" defer></script>
  </body>
</html>
