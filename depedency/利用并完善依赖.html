<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>利用依赖信息更新 browser hash | Vite 源码学习</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/vite-learn/assets/css/0.styles.13e0bdfe.css" as="style"><link rel="preload" href="/vite-learn/assets/js/app.2c7ee9f3.js" as="script"><link rel="preload" href="/vite-learn/assets/js/2.8f7adacc.js" as="script"><link rel="preload" href="/vite-learn/assets/js/12.591f2923.js" as="script"><link rel="prefetch" href="/vite-learn/assets/js/10.92d4399d.js"><link rel="prefetch" href="/vite-learn/assets/js/11.e5276b76.js"><link rel="prefetch" href="/vite-learn/assets/js/13.725b875f.js"><link rel="prefetch" href="/vite-learn/assets/js/14.ad80e4a6.js"><link rel="prefetch" href="/vite-learn/assets/js/15.fee7330a.js"><link rel="prefetch" href="/vite-learn/assets/js/16.5084fc75.js"><link rel="prefetch" href="/vite-learn/assets/js/17.d54d0bf0.js"><link rel="prefetch" href="/vite-learn/assets/js/18.2d29ec62.js"><link rel="prefetch" href="/vite-learn/assets/js/19.31bbcb69.js"><link rel="prefetch" href="/vite-learn/assets/js/20.857f00c0.js"><link rel="prefetch" href="/vite-learn/assets/js/21.7c05d01d.js"><link rel="prefetch" href="/vite-learn/assets/js/22.bc53c9c5.js"><link rel="prefetch" href="/vite-learn/assets/js/23.11dc65cd.js"><link rel="prefetch" href="/vite-learn/assets/js/24.19f32ccd.js"><link rel="prefetch" href="/vite-learn/assets/js/25.e036f7c2.js"><link rel="prefetch" href="/vite-learn/assets/js/26.4cfa5155.js"><link rel="prefetch" href="/vite-learn/assets/js/3.ff647eb2.js"><link rel="prefetch" href="/vite-learn/assets/js/4.aa1e20fb.js"><link rel="prefetch" href="/vite-learn/assets/js/5.3510c9da.js"><link rel="prefetch" href="/vite-learn/assets/js/6.346ac952.js"><link rel="prefetch" href="/vite-learn/assets/js/7.c087e119.js"><link rel="prefetch" href="/vite-learn/assets/js/8.89123153.js"><link rel="prefetch" href="/vite-learn/assets/js/9.ade172d4.js">
    <link rel="stylesheet" href="/vite-learn/assets/css/0.styles.13e0bdfe.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vite-learn/" class="home-link router-link-active"><!----> <span class="site-name">Vite 源码学习</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="//github.com/director-zhou/vite-learn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="//github.com/director-zhou/vite-learn/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>依赖预构建</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vite-learn/depedency/为什么需要预构建一.html" class="sidebar-link">为什么需要预构建(一)</a></li><li><a href="/vite-learn/depedency/为什么需要预构建二.html" class="sidebar-link">为什么需要预构建(二)</a></li><li><a href="/vite-learn/depedency/预构建触发时机.html" class="sidebar-link">预构建触发时机</a></li><li><a href="/vite-learn/depedency/预构建执行逻辑.html" class="sidebar-link">预构建执行逻辑</a></li><li><a href="/vite-learn/depedency/预构建核心方法optimizeDeps.html" class="sidebar-link">预构建核心方法optimizeDeps</a></li><li><a href="/vite-learn/depedency/构建准备.html" class="sidebar-link">构建准备</a></li><li><a href="/vite-learn/depedency/自动依赖搜寻.html" class="sidebar-link">自动依赖搜寻</a></li><li><a href="/vite-learn/depedency/确定扫描入口文件.html" class="sidebar-link">确定扫描入口文件</a></li><li><a href="/vite-learn/depedency/如何执行扫描.html" class="sidebar-link">如何执行扫描</a></li><li><a href="/vite-learn/depedency/esbuild插件基础介绍.html" class="sidebar-link">esbuild插件基础介绍</a></li><li><a href="/vite-learn/depedency/收集依赖插件esbuildScanPlugin.html" class="sidebar-link">收集依赖插件esbuildScanPlugin</a></li><li><a href="/vite-learn/depedency/HTML入口扫描.html" class="sidebar-link">HTML入口扫描</a></li><li><a href="/vite-learn/depedency/扫描导入链路.html" class="sidebar-link">扫描导入链路</a></li><li><a href="/vite-learn/depedency/收集依赖.html" class="sidebar-link">收集依赖</a></li><li><a href="/vite-learn/depedency/利用并完善依赖.html" class="active sidebar-link">利用并完善依赖</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vite-learn/depedency/利用并完善依赖.html#利用依赖信息更新-browser-hash" class="sidebar-link">利用依赖信息更新 browser hash</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/利用并完善依赖.html#报错提示缺失的依赖" class="sidebar-link">报错提示缺失的依赖</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/利用并完善依赖.html#添加-optimizedeps-include-依赖" class="sidebar-link">添加 optimizeDeps.include 依赖</a></li><li class="sidebar-sub-header"><a href="/vite-learn/depedency/利用并完善依赖.html#构建依赖前的提示" class="sidebar-link">构建依赖前的提示</a></li></ul></li><li><a href="/vite-learn/depedency/构建前准备工作.html" class="sidebar-link">构建前准备工作</a></li><li><a href="/vite-learn/depedency/构建文件处理esbuildDepPluginOne.html" class="sidebar-link">构建文件处理esbuildDepPlugin(一)</a></li><li><a href="/vite-learn/depedency/构建文件处理esbuildDepPluginTwo.html" class="sidebar-link">构建文件处理esbuildDepPlugin(二)</a></li><li><a href="/vite-learn/depedency/生成依赖元信息完成构建.html" class="sidebar-link">生成依赖元信息完成构建</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="利用依赖信息更新-browser-hash"><a href="#利用依赖信息更新-browser-hash" class="header-anchor">#</a> 利用依赖信息更新 <code>browser hash</code></h2> <p>在预构建启动前已经生成了 <code>main hash</code>, 同时 <code>browser hash</code> 也等于 <code>main hash</code>, 如果不进行预构建的情况下 <code>main hash</code> 与 <code>browser hash</code> 相同。</p> <h3 id="main-hash"><a href="#main-hash" class="header-anchor">#</a> main hash</h3> <p><code>main hash</code> 的生成是用来重新启动时，比对当前生成的 <code>main hash</code> 与上次构建参照的 <code>main hash</code> 是否需要进行重新执行构建。</p> <h3 id="browser-hash"><a href="#browser-hash" class="header-anchor">#</a> browser hash</h3> <p><code>browser hash</code> 在浏览加载资源的时候, 告诉浏览器是否需要向服务端重新加载资源, <a href="/vite-learn/depedency/预构建触发时机.html#浏览器导入资源时触发">在预构建扫描入口的情况下并不会总是把所有文件扫描干净</a>，收集到应该收集的所有依赖。等到浏览器启动加载资源时, 如果此资源是需要进行预构建，在构建元信息内容中找到构建内容，将会再次进行与原有依赖内容合并后再次构建后，自动重新刷新浏览器, 重新预构建的内容将需要重服务端重新获取。因为构建内容将会重新改变, 不能再次利用 <code>304</code> 缓存, 需要向服务器再次重新请求最新资源。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token comment">// update browser hash</span>
  data<span class="token punctuation">.</span>browserHash <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>hash <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
</code></pre></div><p>生成方式与 <code>main hash</code> 一样，调用 <code>node</code> 模块 <code>crypto</code> 的 <code>createHash</code> 方法对进行 <code>hash</code> 加密,截取<code>8</code>位，加密的内容是由 <code>main hash</code> + <code>所收集的所有依赖</code>。这样就可以确保在开发中, 自动重新预构建时候，保证加载的是最新的资源。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>这里需要一张理解图
尽请期待....</p></div> <h2 id="报错提示缺失的依赖"><a href="#报错提示缺失的依赖" class="header-anchor">#</a> 报错提示缺失的依赖</h2> <p>在项目中，如果缺少任务一个导入模块包<code>(NPM包)</code>, 这必定是一个无法正常运行的项目, 在收集依赖时，如果发现缺少对应依赖的文件内容时，<strong>Vite</strong> 将会中断赖个构建过种, 通过报错提示告诉开发者。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> missingIds <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>missing<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>missingIds<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The following dependencies are imported but could not be resolved:\n\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>missingIds
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span>white<span class="token punctuation">.</span><span class="token function">dim</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(imported by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>missing<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\nAre they installed?</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

</code></pre></div><p><code>missing</code> 的数据结构是由导模块名称作为 <code>key</code>, 所有导入模块的文件路径作为 <code>value</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// /user/admin/project/src/main.js 文件</span>
<span class="token keyword">import</span> dayjs <span class="token keyword">from</span> <span class="token string">'dayjs'</span>

<span class="token comment">// 返回的数据格式</span>

<span class="token punctuation">{</span>
  <span class="token string">&quot;dayjs&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;/user/admin/project/src/main.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>提取 <code>missing</code> 中的 <code>key</code> 通过抛错进行通知。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这里需要加一个报错图
尽请期待....</p></div> <h2 id="添加-optimizedeps-include-依赖"><a href="#添加-optimizedeps-include-依赖" class="header-anchor">#</a> 添加 <code>optimizeDeps.include</code> 依赖</h2> <p>之前是通过文件入口进行扫描, 某些情况下入口扫描<a href="/vite-learn/depedency/预构建触发时机.html#浏览器导入资源时触发">无法完全扫描</a>, 需要在加载资源的时候会进行重新预构建, <code>pre-bundle</code> 是队列的形式，队列一旦比较多，会影响启动速度，不断重新构建，重新刷新页面。</p> <p>入口扫描加入依赖的内容只会存在 <strong>bare Import</strong>, 表示从 <code>node_modules</code> 包导入的模块
<a href="/vite-learn/depedency/为什么需要预构建二.html#性能">同时还可以解决业务模块同时导入一个模块后, 进行再进行导出的方式会影响加载性能</a>，会占用大量<code>connect</code>连接线程进行阻塞加载, 可以通过 <code>include</code> 加入依赖, 进行合并构建。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> include <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token operator">?.</span>include
  <span class="token keyword">if</span> <span class="token punctuation">(</span>include<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> resolve <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">createResolver</span><span class="token punctuation">(</span><span class="token punctuation">{</span> asSrc<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> id <span class="token keyword">of</span> include<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> entry <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          deps<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> entry
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to resolve force included dependency: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>通过 <code>config</code> 的配置获取 <code>include</code> 数组，如果存在 <code>include</code> 依赖，通过 <code>for of</code> 循环, 如果模块已经被收集依赖则过滤,否则对模块进行解析文件路径,无法解析到预期的文件路径则提示报错，错误内容为 <code>include</code> 中的依赖收集 <code>id</code>。 路径解析成功，则加入构建依赖收集项中。</p> <div class="custom-block danger"><p class="custom-block-title">不符合构建文件类型</p> <p>如果 <code>include</code> 中导入解析的文件非 <code>.js</code> 或者 <code>.mjs</code> 被 <code>es-module-lexer</code> 后续词法分析进行抛错。</p></div> <h1 id="未收集到依赖"><a href="#未收集到依赖" class="header-anchor">#</a> 未收集到依赖</h1> <p>在服务启动前是否收集到构建依赖分为两点:</p> <ol><li>入口扫描是否收集到依赖。</li> <li><code>optimizeDeps.include</code> 中是否包含依赖。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> qualifiedIds <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>deps<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>qualifiedIds<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">writeFile</span><span class="token punctuation">(</span>dataPath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No dependencies to bundle. Skipping.\n\n\n</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> data
<span class="token punctuation">}</span>
</code></pre></div><p>声明 <code>qualifiedIds</code> 变量, 通过 <code>Object.keys</code> 进行收集构建依赖的模块名称, 如果不存在任何需要构建的依赖,把 <code>data</code> 元数据数进行返回赋值到 <code>server._optimizeDepsMetadata</code>属性上。同时向缓存文件进行写入优化元信息内容。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>此时元信息中只会包含 <code>hash</code>、 <code>browserHash</code>, <code>optimized</code> 构建内容元信息并是一个空的对象, 因为没有进行依赖构建。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// _metadata.json文件</span>
<span class="token punctuation">{</span>
  hash<span class="token operator">:</span> <span class="token constant">XXXXXXXX</span><span class="token punctuation">,</span>
  browserHash<span class="token operator">:</span> <span class="token constant">XXXXXXXX</span><span class="token punctuation">,</span>
  optimized<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h2 id="构建依赖前的提示"><a href="#构建依赖前的提示" class="header-anchor">#</a> 构建依赖前的提示</h2> <p>依赖已经收集完毕了, 马上就要临近构建了, 在构建前需要提示开发者, 当前构建了那些依赖。
预构建的执行会在三处。这三处理的执行预构建方法给开发者的提示都不一样。</p> <blockquote><p>通过控制台命令行进行指令调用</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">greenBright</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Optimizing dependencies:\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>depsString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>只通知优化内容</p> <blockquote><p>调用vite createServer启动前调用</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
  chalk<span class="token punctuation">.</span><span class="token function">greenBright</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pre-bundling dependencies:\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>depsString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(this will be run only when your dependencies or config have changed)</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>

</code></pre></div><p>不但通知优化内容，还进行提示: <a href="/vite-learn/depedency/预构建核心方法optimizeDeps.html#optimizedeps方法参数以及返回值"><code>通过配置进行改动，将重新进行预构建</code></a></p> <blockquote><p>启动后加载资源时进行调用</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asCommand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>newDeps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This is auto run on server start - let the user know that we are</span>
    <span class="token comment">// pre-optimizing deps</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
      chalk<span class="token punctuation">.</span><span class="token function">greenBright</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pre-bundling dependencies:\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>depsString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(this will be run only when your dependencies or config have changed)</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">greenBright</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Optimizing dependencies:\n  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>depsString<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li><code>asCommand</code> 表示是否是命令行启动。</li> <li><code>newDeps</code> 表示是否是加载时执行的优化。</li></ol> <p>不进行任何提示, 在进行<a href="/vite-learn/depedency/预构建执行逻辑.html#加载资源时优化的执行逻辑">加载资源时优化的执行逻辑</a>时内部分进行提示。</p> <blockquote><p>depsString 生成方法</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> total <span class="token operator">=</span> qualifiedIds<span class="token punctuation">.</span>length
<span class="token keyword">const</span> maxListed <span class="token operator">=</span> <span class="token number">5</span>
<span class="token keyword">const</span> listed <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> maxListed<span class="token punctuation">)</span>
<span class="token keyword">const</span> extra <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> total <span class="token operator">-</span> maxListed<span class="token punctuation">)</span>
<span class="token keyword">const</span> depsString <span class="token operator">=</span> chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
  qualifiedIds<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> listed<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token punctuation">(</span>extra <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n  (...and </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>extra<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> more)</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>变量 <code>total</code> 是需要构建依赖的总数。
变量 <code>maxListed</code> 表示最大只展示 <code>5</code> 条构建依赖模块名称。
变量 <code>listed</code> 表示得到最小的截取数量, 如果依赖总数小于 <code>maxListed</code>,则用 <code>total</code>,否则用 <code>maxListed</code>。
变量 <code>extra</code> 表示大于 <code>5</code> 条构建依赖条目时，还有多少省略展示。</p> <blockquote><p>展示的构建提示内容</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>Pre<span class="token operator">-</span>bundling dependencies<span class="token operator">:</span>
  vue
  ant<span class="token operator">-</span>design<span class="token operator">-</span>vue
  @ant<span class="token operator">-</span>design<span class="token operator">/</span>icons<span class="token operator">-</span>vue
  vue<span class="token operator">-</span>router
  <span class="token function">vuex</span>
  <span class="token punctuation">(</span><span class="token operator">...</span>and <span class="token number">9</span> more<span class="token punctuation">)</span>
<span class="token punctuation">(</span><span class="token keyword">this</span> will be run only when your dependencies or config have changed<span class="token punctuation">)</span>
</code></pre></div><p>总共有 <code>14</code> 条需要构建的依赖, 只展示了前 <code>5</code> 个，<code>9</code> 个将被省略展示。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vite-learn/depedency/收集依赖.html" class="prev">
        收集依赖
      </a></span> <span class="next"><a href="/vite-learn/depedency/构建前准备工作.html">
        构建前准备工作
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/vite-learn/assets/js/app.2c7ee9f3.js" defer></script><script src="/vite-learn/assets/js/2.8f7adacc.js" defer></script><script src="/vite-learn/assets/js/12.591f2923.js" defer></script>
  </body>
</html>
